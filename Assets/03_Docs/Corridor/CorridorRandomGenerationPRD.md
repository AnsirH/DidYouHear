# 요구사항 명세서: 복도 랜덤 생성

## 1. 개요

게임에서 플레이어가 진행할 복도는 **매번 다른 구성**으로 생성되어야 하며, 각 복도 조각에는 이벤트가 포함될 수도 있고 포함되지 않을 수도 있다. 이를 통해 **리플레이성**과 **긴장감 유지**를 보장한다.

---

## 2. 목적

- 매 플레이마다 **새로운 경험**을 제공하여 반복 플레이의 가치를 높인다.
- 직선형, 코너형 복도를 조합하여 **복도 탐색의 다양성**을 제공한다.
- 랜덤 이벤트 배치를 통해 플레이어가 항상 주의를 기울이도록 한다.

---

## 3. 기능 요구사항 상세

### [REQ-CORRIDOR-01] 복도 조각 개수

- **설명**: 게임 시작 시 전체 맵은 일정 수의 복도 조각으로 구성된다.
- **세부 조건**:
    - 총 복도 조각 수는 **30~40개**. ( 추후에 수정 가능 )
    - 매 플레이마다 무작위로 선택 및 연결.
    - 최종 복도는 반드시 탈출 복도로 구성되어야 한다.

---

### [REQ-CORRIDOR-02] 복도 구조 유형

- **설명**: 복도 조각은 2가지 구조 중 하나를 가진다.
- **세부 조건**:
    - **직선형**: 플레이어가 단순히 직진.
    - **코너형**: 좌측/우측 방향으로 90도 회전하는 구간. 플레이어가 따로 조작하지 않아도 자동으로 회전하도록 구현.
    - 복도 구조는 랜덤으로 배치되며, 코너형의 비율은 전체의 **30~50%** 권장.

---

### [REQ-CORRIDOR-03] 이벤트 배치

- **설명**: 각 복도 조각에는 일정 확률로 환경 이벤트를 배치할 수 있다.
- **세부 조건**:
    - 이벤트 발생 확률: **10~20%**.
    - 환경 이벤트 종류
        - 교실 불이 켜짐
        - 화장실 물 소리
        - 문이 갑자기 열림
        - 창문이 갑자기 열림
    - 이벤트 없는 복도 조각도 존재.

---

### [REQ-CORRIDOR-04] 그리드 기반 경로 생성

- **설명**: 복도 겹침 방지를 위해 그리드 기반 경로를 먼저 생성한 후 복도를 배치한다.
- **세부 조건**:
    - **그리드 크기**: 2D 그리드 (예: 50x50)
    - **그리드 셀 크기**: 복도 길이와 동일 (8미터)
    - **경로 생성 알고리즘**:
        1. 시작점에서 랜덤 워크(Random Walk) 방식으로 경로 생성
        2. 이미 사용된 셀은 재사용 불가
        3. 코너 확률에 따라 좌/우 회전 결정
        4. 최소/최대 복도 개수 조건 만족 시 종료
    - **경로 검증**: 생성된 경로가 겹치지 않고 연결되어 있는지 확인
    - **경로 최적화**: 불필요한 루프나 데드엔드 제거
    - **방향 기반 복도 선택**: 경로의 방향 변화에 따라 적절한 복도 타입 자동 선택

---

### [REQ-CORRIDOR-05] 방향 기반 복도 타입 결정

- **설명**: 그리드 경로의 방향 변화를 분석하여 적절한 복도 조각을 선택한다.
- **세부 조건**:
    - **직진 방향**: `currentDirection == nextDirection` → 직진 복도 (교실, 교실&화장실)
    - **우회전**: `new Vector2Int(currentDirection.y, -currentDirection.x) == nextDirection` → 우회전 코너
    - **좌회전**: `new Vector2Int(-currentDirection.y, currentDirection.x) == nextDirection` → 좌회전 코너
    - **방향 계산**: 이전 위치와 다음 위치의 차이로 방향 벡터 계산
    - **자동 선택**: 수동 설정 없이 경로에 따라 자동으로 복도 타입 결정

---

### [REQ-CORRIDOR-06] 연결점 기반 복도 배치

- **설명**: 복도 조각의 시작점과 끝점을 이용하여 정확한 연결을 보장한다.
- **세부 조건**:
    - **시작점/끝점**: 각 복도 조각에 `startPoint`와 `endPoint` Transform 할당
    - **시작 복도**: `startPoint` 없음 (첫 번째 복도)
    - **끝 복도**: `endPoint` 없음 (마지막 복도)
    - **중간 복도**: `startPoint`와 `endPoint` 모두 보유
    - **정확한 배치**: 이전 복도의 `endPoint`와 다음 복도의 `startPoint` 연결
    - **유연한 크기**: 복도의 길이, 폭, 방향에 상관없이 정확한 연결 보장

---

### [REQ-CORRIDOR-07] 매 플레이 다른 구성

- **설명**: 게임 시작 시 매번 새로운 복도 및 이벤트 구성이 생성되어야 한다.
- **세부 조건**:
    - 복도 조각 선택, 연결 순서, 이벤트 배치 모두 랜덤화.
    - 이전 플레이 구성과 동일한 맵이 반복되지 않도록 보장.
    - 최소 **3회 연속 플레이**에서도 충분히 다른 경험 제공 가능.

---

## 4. 비기능 요구사항

- 복도 생성 알고리즘은 **게임 시작 1초 이내**에 완료되어야 한다.
- 복도 조각 및 이벤트 배치는 메모리 효율적으로 로드/언로드 되어야 한다.
- 랜덤 생성 로직은 재현 가능한 시드(seed) 설정 가능하도록 설계.
- 그리드 기반 경로 생성은 **0.5초 이내**에 완료되어야 한다.

---

## 5. 구현 상태

### ✅ 완료된 기능
- **그리드 기반 경로 생성**: `GenerateGridPath()` 메서드로 랜덤 워크 방식 구현
- **방향 기반 복도 선택**: `DetermineCorridorTypeFromDirection()` 메서드로 자동 복도 타입 결정
- **연결점 기반 배치**: `startPoint`/`endPoint` Transform을 이용한 정확한 복도 연결
- **백트래킹 시스템**: 데드엔드 시 이전 위치로 돌아가기 구현
- **이벤트 배치**: `DistributeEvents()` 메서드로 랜덤 이벤트 배치
- **전용 에디터**: `CorridorGeneratorEditor`로 인스펙터에서 맵 재생성 가능
- **분포 분석**: `LogCorridorDistribution()` 메서드로 복도 분포 정보 출력
- **그리드 설정**: `gridSize` 변수 정의 및 그리드 시스템 완성

### ✅ 추가된 기능
- **맵 재생성 버튼**: 인스펙터에서 원클릭으로 맵 재생성
- **시드 관리**: 랜덤 시드 설정 및 리셋 기능
- **실시간 정보**: 런타임에서 복도 개수 및 분포 확인
- **디버그 로그**: 상세한 복도 분포 통계 출력

### 🎯 완성도
- **핵심 로직**: 100% 완성
- **에디터 도구**: 100% 완성
- **전체 시스템**: 95% 완성

---

## 6. 예외 처리

- 이벤트 배치 수가 너무 적어 난이도가 낮은 경우 추가로 이벤트를 배치하여 조율한다.
- 그리드 경로 생성 시 데드엔드에 도달하면 백트래킹하여 다른 경로 탐색.
- 그리드 경계를 벗어나는 경우 경로를 그리드 내부로 재조정.
- 경로 생성 실패 시 기본 직선 경로로 대체하여 게임 진행 보장.